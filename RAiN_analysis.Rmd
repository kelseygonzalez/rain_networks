---
title: "RAiN analysis"
author: "Nicolas Legewie"
date: "11/30/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

##### Load packages #####

if (!require("pacman")) install.packages("pacman")
pacman::p_load(tidyverse, glue, extrafont, cowplot)


##### Set version ##### I think we don't need this bit here

# version <- 'pretest'
version <- 'fullsurvey'


##### Set wd #####

Paths <- c("/Users/neikos/Documents/work/Stat_code_R_RAiN networks/rain_networks/", 
          "YOUR PATH")

names(Paths) = c("neikos", "YOUR USERNAME")

setwd(Paths[Sys.info()[7]])

##### Load data #####

files <- file.info(list.files("data/", full.names = TRUE))

files_filtered <- filter(files, grepl("rds", row.names(files))) %>% filter(grepl("fullsurvey", row.names(.)))

clean_data <- readRDS(rownames(files_filtered)[order(rownames(files_filtered))][nrow(files_filtered)])

##### Remove Rejected Data #####
mturk_batches <- read_csv('data/Batch_1_results.csv') %>% 
  mutate(batch = 1) %>% 
  bind_rows(mutate(read_csv('data/Batch_2_results.csv'), batch = 2)) %>% 
  bind_rows(mutate(read_csv('data/Batch_3_results.csv'), batch = 3)) %>% 
  filter(AssignmentStatus == "Rejected")

clean_data <- clean_data %>% 
  anti_join(mturk_batches, by= c("MID" = "WorkerId"))


##### Prepare environment #####

### Load fonts ###
loadfonts()


##### Define themes #####

main_theme <- theme_light() + 
              theme(
                text = element_text(size = 12, family = "Merriweather Sans"),
                plot.margin = unit(rep(1, 4), "cm"),
                axis.title.x = element_text(margin = margin(15, 0, 0, 0)),
                axis.title.y = element_text(margin = margin(0, 15, 0, 0)))


main_theme_noMargin <- theme_light() + 
              theme(
                text = element_text(size = 12, family = "Merriweather Sans"),
                axis.title.x = element_text(margin = margin(15, 0, 0, 0)),
                axis.title.y = element_text(margin = margin(0, 15, 0, 0)))


main_theme_noMargin_smallFont <- theme_light() + 
              theme(
                text = element_text(size = 10, family = "Merriweather Sans"),
                axis.title.x = element_text(margin = margin(15, 0, 0, 0)),
                axis.title.y = element_text(margin = margin(0, 15, 0, 0)))

```


### To Do

* Check Small stuff for angles  
  
* Add SES of origin to demo & SES descriptives   
* Change colors in demo & SES descriptives (by changing column type)   
* Income descr plot: NAs are not displayed  
* Distrubtion of activation instances (overall, per type)  
* Rate of match: Activation ties v. "important ties"
* Differences in tie numbers: age, gender, race, education, income  
* Differences in activation instances: age, gender, race, SES  
* Differences in rate of match: age, gender, race, SES  



### Descriptive statistics

## Demographics and SES

```{r descriptives_demoSES, echo = FALSE, message = FALSE, warning = FALSE}

# Age: desnity plot
age_descrPlot <- clean_data %>%
  ggplot(aes(age)) +
    geom_density() +
    main_theme_noMargin_smallFont

# Gender: Bar plot
gender_descrPlot <- clean_data %>%
  ggplot(aes(gender, fill = gender)) +
    geom_bar(aes(y = (..count..)/sum(..count..)), show.legend = FALSE) +
    main_theme_noMargin_smallFont +
    coord_flip()

# Race: Bar plot
race_descrPlot <- clean_data %>%
  mutate(race = ifelse(hispanic == "Yes", "White Hispanic", race)) %>%
  ggplot(aes(race, fill = race)) +
    geom_bar(aes(y = (..count..)/sum(..count..)), show.legend = FALSE) +
    main_theme_noMargin_smallFont +
    coord_flip()

# Education: Bar plot
educ_descrPlot <- clean_data %>%
  ggplot(aes(educ, fill = educ)) +
    geom_bar(aes(y = (..count..)/sum(..count..)), show.legend = FALSE) +
    main_theme_noMargin_smallFont +
    coord_flip()

# Income: Bar plot
income_descrPlot <- clean_data %>%
  ggplot(aes(income, fill = income)) +
    geom_bar(aes(y = (..count..)/sum(..count..)), show.legend = FALSE) +
    main_theme_noMargin_smallFont +
    coord_flip()

# Employment status: Bar plot
employm_descrPlot <- clean_data %>%
  ggplot(aes(employment, fill = employment)) +
    geom_bar(aes(y = (..count..)/sum(..count..)), show.legend = FALSE) +
    main_theme_noMargin_smallFont +
    coord_flip()

# Parents' education: Bar plot
# clean_data %>%
#   mutate(across(c(father_ed, mother_ed), as_factor, levels = c("less than high school", 
#                                                                "High school graduate",
#                                                                "Some college",
#                                                                "Associate's or Technical degree",
#                                                                "Bachelor's Ddegree",
#                                                                "Graduate or professional degree"),
#                                                   ordered = TRUE)) %>%
#   mutate(parents_educ = max(father_ed, mother_ed)) %>%
#   ggplot(aes(parents_educ)) +
#   geom_bar(aes(y = (..count..)/sum(..count..))) +
#   main_theme +
#   coord_flip()

# Display plots
# plot_grid(
#   plotlist = list(age_descrPlot,
#                   gender_descrPlot,
#                   race_descrPlot,
#                   educ_descrPlot,
#                   income_descrPlot,
#                   employm_descrPlot),
#   ncol = 1)

age_descrPlot
gender_descrPlot
race_descrPlot
educ_descrPlot
income_descrPlot
employm_descrPlot


```
  
  
  
  
## Personal network and support activation
  
```{r descriptives_networks, echo = FALSE, message = FALSE}

# Define helper function

# clean_data$important_people[[1]] %>% select(important_alter_name) %>% bind_rows(clean_data$alter_data[[1]] %>% select(alter_name)) %>% mutate(alter_name = ifelse(is.na(alter_name), important_alter_name, alter_name)) %>% select(alter_name) %>% distinct() %>% nrow()

get_nTiesTotal.fun <- function(x, y) {
x %>% select(important_alter_name) %>% bind_rows(y %>% select(alter_name)) %>% mutate(alter_name = ifelse(is.na(alter_name), important_alter_name, alter_name)) %>% select(alter_name) %>% distinct() %>% nrow()
}


### Number of ties
# Generate data

# mutate(nTiesAct = clean_data %>% drop_na(alter_data) %>% .[,44] %>% pull() %>% map_dbl(nrow(distinct(., alter_name))))

nTiesAct_descriptives <- clean_data %>% 
    drop_na(alter_data) %>%
    mutate(nTiesAct = map_dbl(.[,44] %>% pull(), ~nrow(distinct(., alter_name)))) %>% 
    select(ResponseId, MID, nTiesAct)
         
nTiesImp_descriptives <- clean_data %>% 
    drop_na(important_people) %>%
    mutate(nTiesImpFamily = map(.[,43] %>% pull(), ~.x %>% count(important_alter_type) %>% .[1,2]) %>% 
                                                          map_dfr(as_tibble, .name_repair = "universal") %>% pull(),
           nTiesImpNonFamily = map(.[,43] %>% pull(), ~.x %>% count(important_alter_type) %>% .[2,2]) %>% 
                                                          map_dfr(as_tibble, .name_repair = "universal") %>% pull()) %>%
    select(ResponseId, MID, nTiesImpFamily, nTiesImpNonFamily)


nTiesTotal_descriptives <- clean_data %>% 
    drop_na(alter_data) %>%
    drop_na(important_people) %>%
    mutate(nTiesTotal = map2_dbl(.[,43] %>% pull(), .[,44] %>% pull(), get_nTiesTotal.fun)) %>%
    select(ResponseId, MID, nTiesTotal)


nTies_descriptives <- clean_data %>%
  select(ResponseId, MID) %>%
  left_join(nTiesAct_descriptives) %>%
  left_join(nTiesImp_descriptives) %>%
  left_join(nTiesTotal_descriptives) %>%
  pivot_longer(cols = starts_with("nTies"),
               names_to = "tie_type",
               values_to = "n")


# Create plots
nTies_ActPlot <- nTies_descriptives %>%
  ggplot(aes(n, color = tie_type)) +
    geom_density() +
    main_theme_noMargin_smallFont +
    facet_wrap(.~tie_type, scales = "free")



### Activation instances
# Generate data
# map_dbl(alter_data, ~nrow())

nActivation_descrPlot <- clean_data %>% 
  mutate(act_instancesTotal = clean_data$alter_data %>% map_dbl(nrow),
         act_instancesEmo = clean_data$alter_data %>% map(filter, activation_type == "emo") %>% max(activation_instance))


# Per type: distrubtion of activation instances
nActivation_descrPlot <- map(clean_data$alter_data, group_by, act_type) %>% 
  map(~nrow(distinct(., act_instance))) %>% 
  map_dfr(as_tibble, .name_repair = "universal") %>%
  ggplot(aes(value)) +
    geom_density() +
    main_theme_noMargin_smallFont

```